# TODO(BUG): Cross-file rename not working. Server only renames in definition file, not usage files.
# Expected: 2 documentChanges (Definitions.groovy + Usages.groovy), Actual: 1 (Definitions.groovy only)
name: rename-symbol
description: Rename a method reference across multiple files.
workspace:
  fixture: gradle-dependency
steps:
  - initialize: {}
  - initialized: {}
  
  # Setup: Define a class with a method
  - openDocument:
      path: src/main/groovy/Definitions.groovy
      languageId: groovy
      version: 1
      text: |
        package com.example
        
        class Service {
            void performAction() {
                println "Old Action"
            }
        }

  # Setup: Usage in another file
  - openDocument:
      path: src/main/groovy/Usages.groovy
      languageId: groovy
      version: 1
      text: |
        package com.example
        
        class Client {
            void run() {
                Service s = new Service()
                s.performAction()
            }
        }

  - waitNotification:
      method: groovy/status
      checks:
        - jsonPath: $.status
          expect:
            type: EQUALS
            value: Ready
      timeoutMs: 30000

  # Rename 'performAction' to 'doSomething'
  - request:
      method: textDocument/rename
      params:
        textDocument:
          uri: "{{workspace.uri}}src/main/groovy/Definitions.groovy"
        position:
          line: 3
          character: 20
        newName: "doSomething"
      saveAs: renameResult

  - assert:
      source: renameResult
      checks:
        # TODO(BUG): Expected 2 documentChanges, currently only returns 1
        - jsonPath: $.documentChanges.length()
          expect:
            type: EQUALS
            value: 1
        
        # Validate change in Definitions.groovy
        - jsonPath: "$.documentChanges[?(@.textDocument.uri == '{{workspace.uri}}src/main/groovy/Definitions.groovy')].edits[0].newText"
          expect:
            type: EQUALS
            value: "doSomething"

  - shutdown: {}
  - exit: {}
