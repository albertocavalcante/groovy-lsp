name: gradle-hover-deps
description: Gradle workspace should resolve external dependencies referenced by source files.
workspace:
  fixture: gradle-dependency
steps:
  - initialize: {}
  - initialized: {}
  - openDocument:
      path: src/main/groovy/PortMappingDeclaration.groovy
      languageId: groovy
      version: 1
      text: |
        package com.lesfurets.jenkins.unit.declarative.kubernetes

        import com.lesfurets.jenkins.unit.declarative.GenericPipelineDeclaration
        import groovy.transform.Memoized
        import groovy.transform.ToString

        import static com.lesfurets.jenkins.unit.declarative.ObjectUtils.printNonNullProperties

        @ToString(includePackage = false, includeNames = true, ignoreNulls = true)
        class PortMappingDeclaration extends GenericPipelineDeclaration {
            String name
            int containerPort
            int hostPort

            def name(final String name) {
                this.name = name
            }

            def containerPort(final int containerPort) {
                this.containerPort = containerPort
            }

            def hostPort(final int hostPort) {
                this.hostPort = hostPort
            }

            @Memoized
            String toString() {
                return printNonNullProperties(this)
            }
        }

  # Wait for dependency resolution to complete before asserting diagnostics.
  - waitNotification:
      method: window/showMessage
      timeoutMs: 30000
      saveAs: depsMessage
      checks:
        - jsonPath: $.message
          expect:
            type: MATCHES_REGEX
            value: "(Dependencies loaded: .*)|(Could not load Gradle dependencies.*)|(Gradle dependency resolution returned no JARs.*)"

  - assert:
      source: depsMessage
      checks:
        - jsonPath: $.message
          expect:
            type: MATCHES_REGEX
            value: "Dependencies loaded: .*"
  - waitNotification:
      method: textDocument/publishDiagnostics
      saveAs: resolvedDiagnostics
      timeoutMs: 60000 # Increased to 60s to allow Gradle resolution
      checks:
        - jsonPath: $.uri
          expect:
            type: EQUALS
            value: "{{workspace.uri}}src/main/groovy/PortMappingDeclaration.groovy"
        - jsonPath: $.diagnostics[?(@.source=='Groovy')]
          expect:
            type: EMPTY
  - shutdown: {}
  - exit: {}
