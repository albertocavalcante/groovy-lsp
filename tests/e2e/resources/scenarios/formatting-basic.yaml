name: formatting-basic
description: >
  Test textDocument/formatting. Includes test case for Issue #393:
  OpenRewrite formatter regression that removes space after opening brace in closures.
workspace:
  fixture: empty-workspace
steps:
  - initialize: {}
  - initialized: {}
  # Wait for server to be ready before making requests
  - waitNotification:
      method: groovy/status
      checks:
        - jsonPath: $.status
          expect:
            type: EQUALS
            value: Ready
      timeoutMs: 180000

  # Test 1: Basic formatting - should preserve closure brace spacing
  # Issue #393: "{ a -> a * 2 }" should not become "{a -> a * 2 }"
  - openDocument:
      path: src/FormatTest.groovy
      languageId: groovy
      version: 1
      text: |
        def myList = [1, 2, 3]
        def doubled = myList.collect { a -> a * 2 }
        println doubled
  - request:
      method: textDocument/formatting
      params:
        textDocument:
          uri: "{{workspace.uri}}src/FormatTest.groovy"
        options:
          tabSize: 4
          insertSpaces: true
      saveAs: formatResult

  # Verify formatting returns edits (or empty if already formatted)
  # The main test is that formatting doesn't break the code
  - assert:
      source: formatResult
      checks:
        - jsonPath: $
          expect:
            type: EXISTS

  # Test 2: Format with closure - verify space is preserved
  - openDocument:
      path: src/ClosureTest.groovy
      languageId: groovy
      version: 1
      text: |
        class ClosureTest {
            def process() {
                def items = [1, 2, 3]
                items.each { item ->
                    println item
                }
            }
        }
  - request:
      method: textDocument/formatting
      params:
        textDocument:
          uri: "{{workspace.uri}}src/ClosureTest.groovy"
        options:
          tabSize: 4
          insertSpaces: true
      saveAs: closureFormatResult

  - assert:
      source: closureFormatResult
      checks:
        - jsonPath: $
          expect:
            type: EXISTS

  - shutdown: {}
  - exit: {}
