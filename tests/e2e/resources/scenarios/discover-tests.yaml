name: discover-tests
description: Verify groovy/discoverTests custom request discovers Spock specifications

server:
  mode: inProcess

workspace:
  fixture: spock-tests

steps:
  - initialize: {}
  - initialized: {}

  # Open the Spock spec file to trigger compilation
  - openDocument:
      path: src/test/groovy/com/example/CalculatorSpec.groovy
      languageId: groovy

  # Wait for Gradle dependency resolution to complete
  # In in-process mode, server->client notifications don't work until JSON-RPC
  # connection is established (after first request/response cycle). Since
  # initialized() triggers async resolution before this, we use a fixed wait.
  # Gradle resolution typically takes 5-6s on warm cache, 60-180s on cold.
  - wait:
      duration: 10000

  # Custom groovy/discoverTests request - uses typed GroovyLanguageServerProtocol proxy
  # for proper response deserialization. This is handled by CustomRequest.DiscoverTests
  # in StepExecutors.kt which routes through session.groovyServer.discoverTests().
  - request:
      method: groovy/discoverTests
      params:
        workspaceUri: '{{workspace.uri}}'
      saveAs: result

  # Verify the response structure
  - assert:
      source: result
      checks:
        # Check that we got at least one test suite
        - jsonPath: $.length()
          expect:
            gte: 1
        # Check the first suite has the expected class name
        - jsonPath: $[0].suite
          expect:
            contains: 'CalculatorSpec'
        # Check the suite has tests (CalculatorSpec has 2 feature methods)
        - jsonPath: $[0].tests.length()
          expect:
            gte: 1
        # Check tests have names
        - jsonPath: $[0].tests[0].test
          expect:
            not_empty: true
        # Check line numbers are present and valid
        - jsonPath: $[0].tests[0].line
          expect:
            gte: 1

  - shutdown: {}
  - exit: {}
