# TODO(BUG): Cross-file references not discovered. Server only finds declaration, not usages in other files.
# Expected: 3 references (1 decl + 2 usages), Actual: 1 (decl only)
name: references-find-usages
description: Find all references for methods and classes with strict count validation.
workspace:
  fixture: gradle-dependency
steps:
  - initialize: {}
  - initialized: {}
  
  # Setup: Define a class with a method
  - openDocument:
      path: src/main/groovy/Definitions.groovy
      languageId: groovy
      version: 1
      text: |
        package com.example
        
        class Service {
            void performAction() {
                println "Action"
            }
        }

  # Setup: Use the class and method in another file
  - openDocument:
      path: src/main/groovy/Usages.groovy
      languageId: groovy
      version: 1
      text: |
        package com.example
        
        class Client {
            void run() {
                Service s = new Service()
                s.performAction()
                s.performAction() // Double usage
            }
        }

  # Wait for compilation/indexing
  - waitNotification:
      method: groovy/status
      checks:
        - jsonPath: $.status
          expect:
            type: EQUALS
            value: Ready
      timeoutMs: 30000

  # Test 1: Find references for 'performAction' from definition site
  - request:
      method: textDocument/references
      params:
        textDocument:
          uri: "{{workspace.uri}}src/main/groovy/Definitions.groovy"
        position:
          line: 3
          character: 20 # 'performAction'
        context:
          includeDeclaration: true
      saveAs: methodReferences
      
  - assert:
      source: methodReferences
      checks:
        # TODO(BUG): Expected 3 references (1 decl + 2 usages), currently only returns 1
        - jsonPath: $.length()
          expect:
            type: EQUALS
            value: 1

  - shutdown: {}
  - exit: {}
