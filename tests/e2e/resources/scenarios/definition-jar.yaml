name: 'definition-jar'
description: 'Goto definition for class in JAR dependency navigates to extracted source'
workspace:
  fixture: 'gradle-dependency'
  files:
    - path: 'src/main/groovy/DependencyTest.groovy'
      content: |
        package com.example

        import com.example.testlib.Greeter

        class DependencyTest {
            def test() {
                // Should resolve to the source JAR class
                def greeter = new Greeter("World")
                greeter.greet()
            }
        }

steps:
  - initialize: {}
  - initialized: {}
  - openDocument:
      path: 'src/main/groovy/DependencyTest.groovy'
      languageId: 'groovy'
      version: 1
      text: |
        package com.example

        import com.example.testlib.Greeter

        class DependencyTest {
            def test() {
                // Should resolve to the source JAR class
                def greeter = new Greeter("World")
                greeter.greet()
            }
        }

  - waitNotification:
      method: window/showMessage
      checks:
        - jsonPath: '$.message'
          expect:
            type: 'CONTAINS'
            value: 'Resolving build dependencies'
      timeoutMs: 10000

  # Optional: Gradle distribution download (only on cold CI, can take 60-180s)
  # Skips early if "Dependencies loaded" arrives (warm cache scenario)
  - waitNotification:
      method: window/showMessage
      checks:
        - jsonPath: '$.message'
          expect:
            type: 'CONTAINS'
            value: 'Downloading Gradle distribution'
      timeoutMs: 180000
      optional: true

  # After download notification (or skipped), wait for download + resolution to complete
  # If download is happening, this can take 60-180s for the download itself
  - waitNotification:
      method: window/showMessage
      checks:
        - jsonPath: '$.message'
          expect:
            type: 'CONTAINS'
            value: 'Dependencies loaded'
      timeoutMs: 180000

  # Request definition on import at line 3 (Greeter class)
  - request:
      method: 'textDocument/definition'
      params:
        textDocument:
          uri: '{{workspace.uri}}src/main/groovy/DependencyTest.groovy'
        position:
          line: 2
          character: 30
      saveAs: 'definitionResult'

  # Source JAR is available (testlib-sources.jar) so definition should return
  # a file: URI to the extracted Greeter.java source
  - assert:
      source: 'definitionResult'
      checks:
        - jsonPath: '$.items[0].uri'
          expect:
            type: 'MATCHES_REGEX'
            value: 'file:.*extracted-sources.*Greeter\.java'
        - jsonPath: '$.items[0].range.start.line'
          expect:
            type: 'EQUALS'
            value: 0

  - shutdown: {}
  - exit: {}
