name: signature-help-basic
description: >
  Test textDocument/signatureHelp.
  Verifies that available signatures are returned for a method call.
  
  TODO(DEFERRED): #425 - Feature not implemented.
  See: https://github.com/albertocavalcante/groovy-devtools/issues/425
workspace:
  fixture: empty-workspace
steps:
  - initialize: {}
  - initialized: {}
  - waitNotification:
      method: groovy/status
      checks:
        - jsonPath: $.status
          expect:
            type: EQUALS
            value: Ready
      timeoutMs: 60000

  - openDocument:
      path: src/SigHelpTest.groovy
      languageId: groovy
      version: 1
      text: |
        class SigHelpTest {
            void method() {
                println()
            }
        }
  
  - waitNotification:
      method: textDocument/publishDiagnostics
      timeoutMs: 10000

  # Trigger signature help inside parens of println()
  # Line 2 ("        println()"). 4 tabs = 8 spaces (if converted)? or just spaces?
  # Text: "        println()"
  # Indices:
  # 0-7: spaces
  # 8-14: println
  # 15: (
  # 16: )
  # We want position 16 (after '(') or 15 (at '(')?
  # Usually inside parens is index of '(' + 1. So 16.
  - request:
      method: textDocument/signatureHelp
      params:
        textDocument:
          uri: "{{workspace.uri}}src/SigHelpTest.groovy"
        position:
          line: 2
          character: 16
      saveAs: sigHelpResult

  # Verify signatures
  - assert:
      source: sigHelpResult
      checks:
        - jsonPath: $.signatures
          expect:
            type: SIZE
            value: 1 # Expecting at least 1, or exactly 1 if filtered?
                     # println has many overloads in GDK.
                     # Let's check > 0 or verify one specific signature.
            # Actually, standard helper allows exact value or size.
            # If we don't know exact size (overloads), we might need `NOT_EMPTY` or `ANY_CONTAINS`.
            # Let's try explicit SIZE first. If println has many, it might return many.
            # But wait, `println()` with no args matches `println()`.
            # We can use `ANY_CONTAINS` on labels if we supported it on list of objects.
            # For now, let's just check NOT_EMPTY if possible, or SIZE > 0.
            # Harness manual says: "Assertions Must Be Quantitative".
            # "Do not use NOT_EMPTY ... unless ... nondeterministic".
            # Amount of overloads might be deterministic but large.
            # Let's assert we find at least one.
            # Harness doesn't support "GREATER_THAN".
            # I'll assert SIZE 2 if I expect 2, or use a filter.
            # Filter: `$.signatures[?(@.label contains 'println')]` -> Size > 0.
            # Let's use filter to find one simple 'println()' or 'println(Object)'.
        
        - jsonPath: $.signatures[?(@.label == 'public void println()')]
          expect:
            type: SIZE
            value: 1
            message: "Should find 'public void println()' signature"

  - shutdown: {}
  - exit: {}
