#!/bin/sh
# tools/hooks/pre-commit
#
# Modular pre-commit hook script.
# - Enforces branch policies
# - Runs auto-formatting (Spotless/ktlint)
# - Runs static analysis (ShellCheck, ghalint)

set -e 

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_error() { echo "${RED}[ERROR]${NC} $1"; }
log_info() { echo "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo "${YELLOW}[WARN]${NC} $1"; }

# 1. Branch Check
# Check not on main branch (works on Windows/Mac/Linux)
branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$branch" = "main" ]; then
    log_error "Direct commits to main branch are forbidden!"
    echo "Please create a feature branch: git checkout -b your-branch-name"
    exit 1
fi

# 2. ShellCheck
# Check staged .sh files
staged_sh_files=$(git diff --cached --name-only --diff-filter=d | grep -E '\.sh$' || true)
if [ -n "$staged_sh_files" ]; then
    log_info "Running ShellCheck on staged files..."
    if command -v shellcheck >/dev/null 2>&1; then
        # Check files one by one to give clear output (handles spaces safely)
        while IFS= read -r file; do
            if [ -f "$file" ]; then
                if ! shellcheck --rcfile tools/lint/shellcheckrc "$file"; then
                    log_error "ShellCheck failed for $file"
                    exit 1
                fi
            fi
        done <<EOF
$staged_sh_files
EOF
        log_info "ShellCheck passed."
    else
        log_warn "ShellCheck not found. Skipping shell script validation."
    fi
fi

# 3. ghalint (GitHub Actions Lint)
# Check staged workflow files
staged_yml_files=$(git diff --cached --name-only --diff-filter=d | grep -E '\.github/workflows/.*\.ya?ml$' || true)
if [ -n "$staged_yml_files" ]; then
    if command -v ghalint >/dev/null 2>&1; then
        log_info "Running ghalint on staged workflows..."
        # ghalint checks all workflows by default, but we want to ensure we don't block if only unrelated files change
        # However, ghalint usually runs on the whole dir. Let's just run it if any workflow is changed.
        if ! ghalint -c tools/lint/ghalint.yaml run; then
            log_error "ghalint failed. Please fix workflow issues."
            exit 1
        fi
        log_info "ghalint passed."
    else
        log_warn "ghalint not found. Skipping workflow validation."
    fi
fi

# 4. Gradle Formatters (Spotless/Ktlint)
log_info "Running auto-formatting and code quality fixes..."

# Store list of staged files (only .kt files for Kotlin formatting efficiency optimization if desired, 
# but lintFix might touch others. The original hook filtered for .kt re-staging logic, let's keep it safe)
# Actually, let's capture ALL staged files to be safe, or just re-stage what we know Spotless touches.
# The original script prioritized .kt files for re-staging. Let's expand this to common source extensions.
staged_source_files=$(git diff --cached --name-only --diff-filter=d | grep -E '\.(kt|java|groovy|gradle|kts)$' || true)

# Run auto-fixers (spotlessApply + detektAutoCorrect)
./gradlew lintFix --quiet || exit 1

# Re-stage any modified files that were originally staged
# This handles files that were formatted by spotlessApply
if [ -n "$staged_source_files" ]; then
    for file in $staged_source_files; do
        if [ -f "$file" ]; then
            git add "$file"
        fi
    done
fi

log_info "âœ“ Code formatting applied and files re-staged"
