name: CI
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      runner_label:
        description: 'Runner label to use'
        required: false
        type: choice
        options:
          - 'self-hosted'
          - 'magalu'
          - 'cloud'
        default: 'magalu'
      disable_scan:
        description: Disable Gradle build scan
        required: false
        type: boolean
        default: false
      test_log_level:
        description: 'Gradle log level for test tasks'
        required: false
        type: choice
        options:
          - 'default'
          - 'info'
          - 'debug'
        default: 'default'
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

# ============================================================================
# RUNNER CONFIGURATION
# ============================================================================
# Priority: workflow_dispatch input > CI_RUNNER_LABEL repo variable > self-hosted
#
# Default: magalu runner (ephemeral, no GitHub Actions minutes cost)
#
# Runner options:
#   - self-hosted: Local runner (fastest, no cost)
#   - magalu: Magalu Cloud ephemeral runner (default, use runner-provision.yml first!)
#   - cloud: GitHub-hosted runners (macos-15 for PRs, matrix for main)
#
# To switch runners permanently:
#   Settings â†’ Secrets and variables â†’ Actions â†’ Variables â†’ New repository variable
#   Name: CI_RUNNER_LABEL  Value: cloud (or magalu)
#
# To switch for a single run:
#   Actions â†’ CI â†’ Run workflow â†’ runner_label: <choice>
#
# Magalu Cloud runners:
#   1. Run "Infra: Provision Magalu Runner" workflow first
#   2. Then run CI with runner_label: magalu
#   3. Run "Infra: Destroy Magalu Runner" when done (or wait for nightly cleanup)
#
# NOTE: Avoiding ubuntu-latest due to stability issues causing builds to hang.
# See: https://github.com/actions/runner-images/issues/13182
#
# Available runner labels: https://github.com/actions/runner-images#available-images
# ============================================================================

jobs:
  check-paths:
    runs-on: ubuntu-latest
    outputs:
      run_main_ci: ${{ steps.filter.outputs.run_main_ci }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: ${{ github.event_name == 'pull_request' && 1 || 0 }}
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            run_main_ci:
              - 'src/**'
              - 'gradle/**'
              - '*.gradle'
              - '*.gradle.kts'
              - 'gradle.properties'
              - '.github/workflows/ci.yml'
              - '!infra/**'
              - '!*.md'
              - '!docs/**'
              - '!.github/workflows/runner-*.yml'

  check-runner:
    name: Check Runner Availability
    runs-on: ubuntu-latest
    needs: check-paths
    if: needs.check-paths.outputs.run_main_ci == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      runner_available: ${{ steps.check.outputs.has-runners }}
      needs_provision: ${{ steps.decide.outputs.needs_provision }}
    steps:
      - name: Checkout (for local action)
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          sparse-checkout: .github/actions

      - name: Check for Magalu runners
        id: check
        uses: ./.github/actions/runner-status
        with:
          mode: check
          label: magalu
          github-token: ${{ secrets.GH_PAT_RUNNER }}

      - name: Decide on provisioning
        id: decide
        run: |
          RUNNER_LABEL="${{ github.event.inputs.runner_label || vars.CI_RUNNER_LABEL || 'magalu' }}"
          HAS_RUNNERS="${{ steps.check.outputs.has-runners }}"
          
          echo "Runner label: $RUNNER_LABEL"
          echo "Has runners: $HAS_RUNNERS"
          
          # Only need to provision if targeting magalu and no runners available
          if [[ "$RUNNER_LABEL" == "magalu" && "$HAS_RUNNERS" != "true" ]]; then
            echo "needs_provision=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Magalu runner not available - provisioning required"
          else
            echo "needs_provision=false" >> $GITHUB_OUTPUT
            echo "âœ… Runner available or not using magalu"
          fi

      - name: Trigger provisioning workflow
        if: steps.decide.outputs.needs_provision == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_RUNNER }}
        run: |
          echo "ðŸš€ Triggering runner-provision.yml..."
          gh workflow run runner-provision.yml --repo ${{ github.repository }}
          echo "â³ Provisioning triggered. Manual approval may be required."
          echo ""
          echo "ðŸ‘‰ Go to: https://github.com/${{ github.repository }}/actions/workflows/runner-provision.yml"
          echo ""
          echo "This CI run will wait for the runner to become available."

      - name: Wait for runner to become available
        if: steps.decide.outputs.needs_provision == 'true'
        uses: ./.github/actions/runner-status
        with:
          mode: wait-online
          label: magalu
          github-token: ${{ secrets.GH_PAT_RUNNER }}
          max-wait-minutes: '15'
          poll-interval-seconds: '30'

  build:
    name: Build and Test
    needs: [check-paths, check-runner]
    if: needs.check-paths.outputs.run_main_ci == 'true' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 45
    # For Magalu runners, we need all three labels; for others, use the matrix value directly
    runs-on: ${{ matrix.os == 'magalu' && fromJSON('["self-hosted", "magalu", "groovy-lsp"]') || matrix.os }}
    permissions:
      checks: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        # Runner selection:
        #   - self-hosted (default): Local runner, Java 17 only
        #   - magalu: Magalu Cloud ephemeral runner (provision first via runner-provision.yml)
        #   - cloud: GitHub-hosted (macos-15 for PRs, multi-platform for main)
        # NOTE: Using macos-15 instead of ubuntu-latest due to runner stability issues
        # See: https://github.com/actions/runner-images/issues/13182
        os: ${{ fromJSON( (github.event.inputs.runner_label == 'magalu' || vars.CI_RUNNER_LABEL == 'magalu' || github.event_name == 'push') && '["magalu"]' || (github.event.inputs.runner_label == 'cloud' || vars.CI_RUNNER_LABEL == 'cloud') && (github.event_name == 'pull_request' && '["macos-15"]' || '["macos-15", "ubuntu-24.04"]') || '["magalu"]' ) }}
        java: ${{ fromJSON( (github.event.inputs.runner_label == 'cloud' || vars.CI_RUNNER_LABEL == 'cloud') && (github.event_name == 'pull_request' && '[17]' || '[17, 21]') || '[17]' ) }}
        exclude:
          - os: ubuntu-24.04
            java: 21
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          # Shallow clone for PRs (faster), deep clone for main (SonarCloud needs history)
          fetch-depth: ${{ github.event_name == 'pull_request' && 1 || 0 }}
      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
        with:
          # Allow writing to cache for main OR PRs from the same repository
          # Read-only for forks to prevent cache poisoning
          cache-read-only: ${{ github.ref != 'refs/heads/main' && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository }}
          # Self-hosted runners may have pre-existing Gradle User Home - allow overwrite
          cache-overwrite-existing: ${{ matrix.os == 'self-hosted' }}
      - name: Set Gradle flags
        shell: bash
        run: |-
          # Set scan flag
          if [[ "${{ github.event.inputs.disable_scan }}" == "true" ]]; then
            echo "GRADLE_SCAN_FLAG=-Dorg.gradle.scan=false" >> $GITHUB_ENV
          else
            echo "GRADLE_SCAN_FLAG=" >> $GITHUB_ENV
          fi
          
          # Set test log level flag
          case "${{ github.event.inputs.test_log_level }}" in
            "info")
              echo "TEST_LOG_FLAG=--info" >> $GITHUB_ENV
              ;;
            "debug")
              echo "TEST_LOG_FLAG=--debug" >> $GITHUB_ENV
              ;;
            *)
              echo "TEST_LOG_FLAG=" >> $GITHUB_ENV
              ;;
          esac
      
      # NOTE: --parallel and --build-cache are redundant with gradle.properties settings
      # (org.gradle.parallel=true, org.gradle.caching=true) but kept explicit for:
      # 1. Self-documentation - CI intent is clear without checking gradle.properties
      # 2. Defense in depth - CI works even if gradle.properties changes
      
      # Phase 1: Compile + Lint in single invocation with parallel execution
      - name: Compile and Lint
        run: ./gradlew classes testClasses lint --parallel --build-cache --stacktrace $GRADLE_SCAN_FLAG

      # Phase 2: Unit Tests (generates coverage data in .ic files)
      - name: Run Unit Tests
        timeout-minutes: 20
        run: ./gradlew test --parallel --build-cache --stacktrace $TEST_LOG_FLAG $GRADLE_SCAN_FLAG

      # Phase 3: Coverage Reports (reads .ic files from Phase 2)
      # NOTE: Split from test task to avoid Kover hang bug when running in same invocation
      # with --parallel. See: https://github.com/Kotlin/kotlinx-kover/issues/509
      - name: Generate Coverage Reports
        run: ./gradlew koverXmlReport koverHtmlReport --parallel --build-cache --stacktrace $GRADLE_SCAN_FLAG

      # Phase 4: E2E Tests (automatically builds shadowJar via task dependency)
      # Skip on macOS - E2E tests are platform-independent LSP protocol tests
      - name: Run E2E Tests
        if: matrix.os != 'macos-15'
        timeout-minutes: 30
        run: ./gradlew :tests:e2eTest --parallel --build-cache --stacktrace $TEST_LOG_FLAG $GRADLE_SCAN_FLAG

      # Phase 5: SonarCloud (needs coverage reports from Phase 3)
      - name: SonarCloud Analysis
        if: (matrix.os == 'ubuntu-24.04' || matrix.os == 'self-hosted') && matrix.java == 17 && ((github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main' && github.event.pull_request.head.repo.full_name == github.repository))
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew sonar --info $GRADLE_SCAN_FLAG
        
      - name: Generate Test Report
        uses: dorny/test-reporter@fe45e9537387dac839af0d33ba56eed8e24189e8 # v2.3.0
        if: success() || failure()
        with:
          name: Test Results (${{ matrix.os }} - Java ${{ matrix.java }})
          path: '**/build/test-results/test/*.xml'
          reporter: java-junit
          
      # Verify JAR (already built by e2eTest via shadowJar dependency)
      - name: Verify JAR
        if: (matrix.os == 'ubuntu-latest' && matrix.java == 17) || matrix.os == 'self-hosted'
        run: |-
          echo "Testing JAR with --help flag..."
          java -jar groovy-lsp/build/libs/groovy-lsp-*-all.jar --help
          
      - name: Upload JAR artifact
        if: (matrix.os == 'ubuntu-latest' && matrix.java == 17) || matrix.os == 'self-hosted'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: groovy-lsp-jar-${{ matrix.os }}-java${{ matrix.java }}
          path: groovy-lsp/build/libs/groovy-lsp-*-all.jar
          retention-days: 7
          
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: test-results-${{ matrix.os }}-java${{ matrix.java }}
          path: |-
            **/build/test-results/
            **/build/reports/tests/
            **/build/reports/problems/
            **/build/reports/kover/
          retention-days: 7
  validate:
    name: Validation Check
    runs-on: ${{ github.event.inputs.runner_label == 'self-hosted' && 'self-hosted' || vars.CI_RUNNER_LABEL == 'self-hosted' && 'self-hosted' || 'ubuntu-latest' }}
    needs: build
    if: always()
    steps:
      - name: Check build status
        run: |-
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "Build failed or was cancelled"
            exit 1
          fi
          echo "âœ… All checks passed!"
  dependency-check:
    name: Check Dependencies
    runs-on: ${{ github.event.inputs.runner_label == 'self-hosted' && 'self-hosted' || vars.CI_RUNNER_LABEL == 'self-hosted' && 'self-hosted' || 'ubuntu-latest' }}
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Set up JDK 17
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: temurin
          java-version: 17
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
      - name: Check for dependency updates
        run: ./gradlew dependencyUpdates --refresh-dependencies || true
