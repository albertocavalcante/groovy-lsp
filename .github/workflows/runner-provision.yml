name: "Infra: Provision Magalu Runner"

# This workflow provisions ephemeral self-hosted runners on Magalu Cloud.
# Once provisioned, runners are available for CI workflows using [self-hosted, magalu] labels.
#
# Architecture:
#   - Runners are provisioned on-demand (manual trigger or schedule)
#   - Runners auto-register with GitHub using the PAT
#   - CI workflows can then target these runners
#   - Use runner-destroy.yml to tear down when done

on:
  workflow_dispatch:
    inputs:
      runner_count:
        description: 'Number of runners to provision'
        required: false
        default: '1'
        type: string
      machine_type:
        description: 'Magalu Cloud VM type (BV1-4-10, BV2-8-10, BV4-16-10, BV8-32-10)'
        required: false
        default: 'BV4-16-10'
        type: choice
        options:
          - 'BV1-4-10'
          - 'BV2-8-10'
          - 'BV4-16-10'
          - 'BV8-32-10'
      runner_image:
        description: 'Runner OS image'
        required: false
        default: 'ubuntu-22'
        type: choice
        options:
          - 'ubuntu-22'
          - 'ubuntu-24'
          - 'debian-12'
          - 'debian-13'
          - 'rocky-9'
          - 'oracle-8'
          - 'oracle-9'

env:
  TF_CLOUD_ORGANIZATION: 'alberto'
  TF_WORKSPACE: 'groovy-lsp-runner'
  TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
  TF_VAR_github_token: ${{ secrets.GH_PAT_RUNNER }}
  TF_VAR_mgc_api_key: ${{ secrets.MGC_API_KEY }}
  TF_VAR_runner_count: ${{ github.event.inputs.runner_count || '1' }}
  TF_VAR_machine_type: ${{ github.event.inputs.machine_type || 'BV4-16-10' }}
  TF_VAR_runner_image: ${{ github.event.inputs.runner_image || 'ubuntu-22' }}

jobs:
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    outputs:
      plan_exists: ${{ steps.plan.outcome == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: 1.11.4
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      # TODO: Consider migrating to dflook/terraform-github-actions for better TFC integration
      # Reference: https://github.com/albertocavalcante/hackathons/blob/main/.github/workflows/terraform-plan.yml
      - name: Create TFC Workspace if not exists
        env:
          TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $TF_API_TOKEN" \
            "https://app.terraform.io/api/v2/organizations/$TF_CLOUD_ORGANIZATION/workspaces/$TF_WORKSPACE")
          
          if [ "$STATUS" = "404" ]; then
            echo "Creating workspace $TF_WORKSPACE..."
            curl -s -X POST \
              -H "Authorization: Bearer $TF_API_TOKEN" \
              -H "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2/organizations/$TF_CLOUD_ORGANIZATION/workspaces" \
              -d '{
                "data": {
                  "type": "workspaces",
                  "attributes": {
                    "name": "'"$TF_WORKSPACE"'",
                    "execution-mode": "local",
                    "auto-apply": false
                  }
                }
              }'
            echo "✅ Workspace created"
          else
            echo "✅ Workspace $TF_WORKSPACE already exists"
          fi

      - name: Terraform Init
        working-directory: infra/runner
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: infra/runner
        run: terraform plan -out=tfplan

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: provision-tfplan
          path: infra/runner/tfplan
          retention-days: 1

  apply:
    name: Terraform Apply
    needs: plan
    runs-on: ubuntu-latest
    environment: production # Requires manual approval
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: 1.11.4
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: provision-tfplan
          path: infra/runner

      - name: Terraform Init
        working-directory: infra/runner
        run: terraform init

      - name: Terraform Apply
        working-directory: infra/runner
        run: terraform apply -input=false tfplan

  wait-for-runner:
    name: Wait for Runner Registration
    needs: apply
    runs-on: ubuntu-latest
    outputs:
      runner-name: ${{ steps.wait.outputs.runner-name }}
    steps:
      - name: Checkout (for local action)
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          sparse-checkout: .github/actions
          persist-credentials: false

      - name: Wait for Magalu runner to be online
        id: wait
        uses: ./.github/actions/runner-status
        with:
          mode: wait-online
          label: magalu
          github-token: ${{ secrets.GH_PAT_RUNNER }}
          max-wait-minutes: '10'
          poll-interval-seconds: '10'
