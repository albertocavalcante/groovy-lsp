name: "Infra: Provision Magalu Runner"

# This workflow provisions ephemeral self-hosted runners on Magalu Cloud.
# Once provisioned, runners are available for CI workflows using [self-hosted, magalu] labels.
#
# Architecture:
#   - Runners are provisioned on-demand (manual trigger or schedule)
#   - Runners auto-register with GitHub using the PAT
#   - CI workflows can then target these runners
#   - Use runner-destroy.yml to tear down when done

on:
  workflow_dispatch:
    inputs:
      runner_count:
        description: "Number of runners to provision"
        required: false
        default: "1"
        type: string

env:
  TF_CLOUD_ORGANIZATION: "alberto"
  TF_WORKSPACE: "groovy-lsp-runner"
  TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
  TF_VAR_github_token: ${{ secrets.GH_PAT_RUNNER }}
  TF_VAR_mgc_api_key: ${{ secrets.MGC_API_KEY }}

jobs:
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    outputs:
      plan_exists: ${{ steps.plan.outcome == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@a1502cd9e758c50496cc9ac5308c4843bcd56d36 # v3.0.0
        with:
          terraform_version: 1.5.7
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        working-directory: infra/runner
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: infra/runner
        run: terraform plan -out=tfplan

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: provision-tfplan
          path: infra/runner/tfplan
          retention-days: 1

  apply:
    name: Terraform Apply
    needs: plan
    runs-on: ubuntu-latest
    environment: production # Requires manual approval
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@a1502cd9e758c50496cc9ac5308c4843bcd56d36 # v3.0.0
        with:
          terraform_version: 1.5.7
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: provision-tfplan
          path: infra/runner

      - name: Terraform Init
        working-directory: infra/runner
        run: terraform init

      - name: Terraform Apply
        working-directory: infra/runner
        run: terraform apply -input=false tfplan

  wait-for-runner:
    name: Wait for Runner Registration
    needs: apply
    runs-on: ubuntu-latest
    outputs:
      runner-name: ${{ steps.wait.outputs.runner-name }}
    steps:
      - name: Checkout (for local action)
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          sparse-checkout: .github/actions

      - name: Wait for Magalu runner to be online
        id: wait
        uses: ./.github/actions/runner-status
        with:
          mode: wait-online
          label: magalu
          github-token: ${{ secrets.GH_PAT_RUNNER }}
          max-wait-minutes: '10'
          poll-interval-seconds: '10'
