name: Nightly Build

on:
  schedule:
    - cron: "0 3 * * *" # Daily at 03:00 UTC
  workflow_dispatch:
    inputs:
      ref:
        description: "Ref to build from"
        required: false
        default: "main"
      runner_label:
        description: "Runner label to use"
        required: false
        type: choice
        options:
          - "github-hosted"
          - "self-hosted"
          - "local-macos"
          - "magalu"
        default: "github-hosted"
      skip_tests:
        description: "Skip test suite"
        required: false
        type: boolean
        default: false
      publish_prerelease:
        description: "Publish a GitHub prerelease with nightly artifacts"
        required: false
        type: boolean
        default: false
      disable_scan:
        description: "Disable Gradle build scan"
        required: false
        type: boolean
        default: false

concurrency:
  group: nightly-${{ github.event.inputs.ref || github.ref }}
  cancel-in-progress: false

jobs:
  nightly:
    name: Nightly
    permissions:
      contents: write
    runs-on: ${{ (github.event.inputs.runner_label == 'self-hosted' || vars.CI_RUNNER_LABEL == 'self-hosted') && 'self-hosted' || (github.event.inputs.runner_label == 'local-macos' || vars.CI_RUNNER_LABEL == 'local-macos') && fromJSON('["self-hosted", "local-macos", "groovy-lsp"]') || (github.event.inputs.runner_label == 'magalu' || vars.CI_RUNNER_LABEL == 'magalu') && fromJSON('["self-hosted", "magalu", "groovy-lsp"]') || 'macos-15' }}
    timeout-minutes: 60
    env:
      SKIP_TESTS_INPUT: ${{ github.event.inputs.skip_tests || 'false' }}
      PUBLISH_PRERELEASE_INPUT: ${{ github.event.inputs.publish_prerelease || 'false' }}
      DISABLE_SCAN_INPUT: ${{ github.event.inputs.disable_scan || 'false' }}

    steps:
      - name: Validate ref input
        shell: bash
        env:
          REF_INPUT: ${{ github.event.inputs.ref || 'main' }}
        run: |
          # Validate ref matches allowed patterns: branch names, tags, or SHAs
          if [[ ! "$REF_INPUT" =~ ^[a-zA-Z0-9._/-]+$ ]] || [[ "$REF_INPUT" =~ \.\. ]]; then
            echo "::error::Invalid ref format: $REF_INPUT"
            exit 1
          fi
          echo "Validated ref: $REF_INPUT"
          echo "VALIDATED_REF=$REF_INPUT" >> "$GITHUB_ENV"

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
          ref: ${{ env.VALIDATED_REF || 'main' }}
          persist-credentials: false

      - name: Setup Java
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Configure Gradle flags
        shell: bash
        run: |
          if [[ "${{ env.DISABLE_SCAN_INPUT }}" == "true" ]]; then
            echo "GRADLE_SCAN_FLAG=-Dorg.gradle.scan=false" >> "$GITHUB_ENV"
          else
            echo "GRADLE_SCAN_FLAG=" >> "$GITHUB_ENV"
          fi

      - name: Validate Gradle Wrapper
        run: ./gradlew --no-daemon --version

      - name: Compute nightly version
        id: nightly_version
        shell: bash
        run: |
          set -euo pipefail
          BASE_VERSION=$(python3 - <<'PY'
          import re
          from pathlib import Path

          text = Path("build.gradle.kts").read_text()
          match = re.search(r'val\s+baseVersion\s*=\s*"([^"]+)"', text)
          if not match:
              raise SystemExit("baseVersion not found in build.gradle.kts")
          print(match.group(1))
          PY
          )
          NIGHTLY_VERSION="${BASE_VERSION}-nightly.$(date -u +%Y%m%d%H%M)"
          {
            echo "base_version=$BASE_VERSION"
            echo "nightly_version=$NIGHTLY_VERSION"
            echo "nightly_tag=nightly-${NIGHTLY_VERSION}-${GITHUB_RUN_ID}"
          } >> "$GITHUB_OUTPUT"

      - name: Run lint checks
        run: |
          args=(--no-daemon lint --stacktrace)
          if [[ -n "${GRADLE_SCAN_FLAG}" ]]; then
            args+=("${GRADLE_SCAN_FLAG}")
          fi
          ./gradlew "${args[@]}"

      - name: Run tests
        if: env.SKIP_TESTS_INPUT != 'true'
        run: |
          args=(--no-daemon test :tests:e2eTest --stacktrace)
          if [[ -n "${GRADLE_SCAN_FLAG}" ]]; then
            args+=("${GRADLE_SCAN_FLAG}")
          fi
          ./gradlew "${args[@]}"

      - name: Build Shadow JAR
        run: |
          args=(--no-daemon shadowJar --stacktrace)
          if [[ -n "${GRADLE_SCAN_FLAG}" ]]; then
            args+=("${GRADLE_SCAN_FLAG}")
          fi
          ./gradlew "${args[@]}"

      - name: Verify JAR
        shell: bash
        run: |
          set -euo pipefail
          JAR_PATH=$(find groovy-lsp/build/libs -maxdepth 1 -name 'groovy-lsp-*-all.jar' -print -quit)
          echo "Found JAR: $JAR_PATH"
          java -jar "$JAR_PATH" --help

      - name: Prepare nightly artifacts
        id: prepare_artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          JAR_PATH=$(find groovy-lsp/build/libs -maxdepth 1 -name 'groovy-lsp-*-all.jar' -print -quit)
          SHORT_SHA=$(git rev-parse --short HEAD)
          NIGHTLY_NAME="groovy-lsp-${{ steps.nightly_version.outputs.nightly_version }}-${SHORT_SHA}.jar"
          cp "$JAR_PATH" "dist/${NIGHTLY_NAME}"
          (cd dist && sha256sum "${NIGHTLY_NAME}" > checksums.txt)
          echo "artifact_name=${NIGHTLY_NAME}" >> "$GITHUB_OUTPUT"

      - name: Upload artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: groovy-lsp-nightly-${{ steps.nightly_version.outputs.nightly_version }}
          path: dist/*
          retention-days: 7

      - name: Publish prerelease
        if: env.PUBLISH_PRERELEASE_INPUT == 'true'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ steps.nightly_version.outputs.nightly_tag }}
          name: Nightly ${{ steps.nightly_version.outputs.nightly_version }}
          prerelease: true
          generate_release_notes: false
          files: |
            dist/${{ steps.prepare_artifacts.outputs.artifact_name }}
            dist/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
