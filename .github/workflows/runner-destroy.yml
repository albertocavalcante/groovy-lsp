name: "Infra: Destroy Magalu Runner"

# This workflow tears down ephemeral self-hosted runners on Magalu Cloud.
# Use this to clean up runners after testing, or schedule it for nightly cleanup.
#
# Safety:
#   - Plan step shows what will be destroyed
#   - Apply requires manual approval via 'production' environment

on:
  workflow_dispatch:
  schedule:
    # Run nightly at 3 AM UTC to clean up any leftover runners
    - cron: "0 3 * * *"

env:
  TF_CLOUD_ORGANIZATION: "alberto"
  TF_WORKSPACE: "groovy-lsp-runner"
  TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
  TF_VAR_github_token: ${{ secrets.GH_PAT_RUNNER }}
  TF_VAR_mgc_api_key: ${{ secrets.MGC_API_KEY }}

jobs:
  check-runners:
    name: Check Existing Runners
    runs-on: ubuntu-latest
    outputs:
      has_runners: ${{ steps.check.outputs.has-runners }}
    steps:
      - name: Checkout (for local action)
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          sparse-checkout: .github/actions

      - name: Check for Magalu runners
        id: check
        uses: ./.github/actions/runner-status
        with:
          mode: check
          label: magalu
          github-token: ${{ secrets.GH_PAT_RUNNER }}

  plan-destroy:
    name: Terraform Plan Destroy
    needs: check-runners
    if: needs.check-runners.outputs.has_runners == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@a1502cd9e758c50496cc9ac5308c4843bcd56d36 # v3.0.0
        with:
          terraform_version: 1.11.4
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        working-directory: infra/runner
        run: terraform init

      - name: Terraform Plan Destroy
        working-directory: infra/runner
        run: terraform plan -destroy -out=destroy.tfplan

      - name: Upload Destroy Plan
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: destroy-tfplan
          path: infra/runner/destroy.tfplan
          retention-days: 1

  apply-destroy:
    name: Terraform Destroy
    needs: plan-destroy
    runs-on: ubuntu-latest
    # For scheduled runs, auto-approve; for manual, require approval
    environment: ${{ github.event_name == 'schedule' && 'cleanup' || 'production' }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@a1502cd9e758c50496cc9ac5308c4843bcd56d36 # v3.0.0
        with:
          terraform_version: 1.11.4
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Download Destroy Plan
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: destroy-tfplan
          path: infra/runner

      - name: Terraform Init
        working-directory: infra/runner
        run: terraform init

      - name: Terraform Destroy
        working-directory: infra/runner
        run: terraform apply -input=false destroy.tfplan

      - name: Verify Runners Removed
        uses: ./.github/actions/runner-status
        with:
          mode: verify-absent
          label: magalu
          github-token: ${{ secrets.GH_PAT_RUNNER }}
