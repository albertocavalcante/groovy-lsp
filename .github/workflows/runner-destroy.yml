name: "Infra: Destroy Magalu Runner"

# This workflow tears down ephemeral self-hosted runners on Magalu Cloud.
# Use this to clean up runners after testing, or schedule it for nightly cleanup.
#
# Safety:
#   - Plan step shows what will be destroyed
#   - Apply requires manual approval via 'production' environment

on:
  workflow_dispatch:
  schedule:
    # Run nightly at 3 AM UTC to clean up any leftover runners
    - cron: "0 3 * * *"

env:
  TF_CLOUD_ORGANIZATION: "alberto"
  TF_WORKSPACE: "groovy-lsp-runner"
  TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
  TF_VAR_github_token: ${{ secrets.GH_PAT_RUNNER }}
  TF_VAR_mgc_api_key: ${{ secrets.MGC_API_KEY }}

jobs:
  check-runners:
    name: Check Existing Runners
    runs-on: ubuntu-latest
    outputs:
      has_runners: ${{ steps.check.outputs.has-runners }}
    steps:
      - name: Checkout (for local action)
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          sparse-checkout: .github/actions

      - name: Check for Magalu runners
        id: check
        uses: ./.github/actions/runner-status
        with:
          mode: check
          label: magalu
          github-token: ${{ secrets.GH_PAT_RUNNER }}

      - name: Prune Offline Runners
        uses: ./.github/actions/runner-status
        with:
          mode: prune-offline
          label: magalu
          github-token: ${{ secrets.GH_PAT_RUNNER }}

  plan-destroy:
    name: Terraform Plan Destroy
    needs: check-runners
    if: needs.check-runners.outputs.has_runners == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: 1.11.4
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        working-directory: infra/runner
        run: terraform init

      - name: Terraform Plan Destroy
        working-directory: infra/runner
        run: terraform plan -destroy -out=destroy.tfplan

      - name: Upload Destroy Plan
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: destroy-tfplan
          path: infra/runner/destroy.tfplan
          retention-days: 1

  apply-destroy:
    name: Terraform Destroy
    needs: plan-destroy
    runs-on: ubuntu-latest
    # For scheduled runs, auto-approve; for manual, require approval
    environment: ${{ github.event_name == 'schedule' && 'cleanup' || 'production' }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: 1.11.4
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Download Destroy Plan
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: destroy-tfplan
          path: infra/runner

      - name: Terraform Init
        working-directory: infra/runner
        run: terraform init

      - name: Terraform Destroy
        working-directory: infra/runner
        run: terraform apply -input=false destroy.tfplan

      - name: Verify Runners Removed
        uses: ./.github/actions/runner-status
        with:
          mode: verify-absent
          label: magalu
          github-token: ${{ secrets.GH_PAT_RUNNER }}
