name: Release
"on":
  push:
    tags:
    - v*
  workflow_dispatch:
    inputs:
      runner_label:
        description: 'Runner label to use'
        required: false
        type: choice
        options:
          - 'github-hosted'
          - 'self-hosted'
          - 'local-macos'
          - 'magalu'
        default: 'github-hosted'
      tag:
        description: 'Tag to release (for re-running failed releases)'
        required: false
        type: string
      dry_run:
        description: Dry run (don't create release)
        required: false
        type: boolean
        default: false
      disable_scan:
        description: Disable Gradle build scan
        required: false
        type: boolean
        default: false
jobs:
  build-release:
    name: Build Release Artifacts
    permissions:
      contents: read
    timeout-minutes: 60
    runs-on: ${{ matrix.os == 'self-hosted' && 'self-hosted' || matrix.os == 'local-macos' && fromJSON('["self-hosted", "local-macos", "groovy-lsp"]') || matrix.os == 'magalu' && fromJSON('["self-hosted", "magalu", "groovy-lsp"]') || matrix.os }}
    outputs:
      build_version: ${{ steps.set-env.outputs.build_version }}
      build_commit: ${{ steps.set-env.outputs.build_commit }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ${{ (github.event.inputs.runner_label == 'self-hosted' || vars.CI_RUNNER_LABEL == 'self-hosted') && 'self-hosted' || (github.event.inputs.runner_label == 'local-macos' || vars.CI_RUNNER_LABEL == 'local-macos') && 'local-macos' || (github.event.inputs.runner_label == 'magalu' || vars.CI_RUNNER_LABEL == 'magalu') && 'magalu' || 'ubuntu-24.04' }}
        java:
          - 17
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        ref: ${{ github.event.inputs.tag || github.ref }}
    - name: "Set up JDK ${{ matrix.java }}"
      uses: actions/setup-java@v5
      with:
        distribution: temurin
        java-version: "${{ matrix.java }}"
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5
      with:
        cache-read-only: false
    - name: Set Gradle scan flag
      shell: bash
      run: |-
        if [[ "${{ github.event.inputs.disable_scan }}" == "true" ]]; then
          echo "GRADLE_SCAN_FLAG=-Dorg.gradle.scan=false" >> $GITHUB_ENV
        else
          echo "GRADLE_SCAN_FLAG=" >> $GITHUB_ENV
        fi
    - name: Set build environment variables
      id: set-env
      shell: bash
      run: |
        # Priority: tag input > push tag > fallback (if not a version tag)
        TAG="${{ github.event.inputs.tag }}"
        TAG="${TAG:-${{ github.ref_name }}}"
        # If TAG doesn't look like a version tag (v*), generate manual version
        [[ ! "$TAG" =~ ^v[0-9] ]] && TAG="manual-$(date +%Y%m%d-%H%M%S)"
        
        # Get actual commit SHA from checked-out code (not github.sha which is dispatch trigger)
        COMMIT_SHA=$(git rev-parse HEAD)

        echo "Release version: ${TAG}"
        echo "Commit SHA: ${COMMIT_SHA}"
        echo "BUILD_VERSION=${TAG}" >> $GITHUB_ENV
        echo "BUILD_COMMIT=${COMMIT_SHA}" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
        
        # Set outputs for downstream jobs
        echo "build_version=${TAG}" >> $GITHUB_OUTPUT
        echo "build_commit=${COMMIT_SHA}" >> $GITHUB_OUTPUT
    - name: Validate Gradle Wrapper
      run: ./gradlew --no-daemon --version
    - name: Verify version detection
      run: |
        echo "Verifying smart version detection..."
        ./gradlew --no-daemon printVersion
        echo "Expected release version (without SNAPSHOT): ${BUILD_VERSION#v}"
    - name: Compile and Test
      run: ./gradlew --no-daemon compileKotlin compileTestKotlin test --stacktrace $GRADLE_SCAN_FLAG
    - name: Build Shadow JAR
      run: ./gradlew --no-daemon shadowJar --stacktrace $GRADLE_SCAN_FLAG
    - name: Test JAR
      shell: bash
      run: |
        echo "Testing JAR with --help flag..."
        java -jar groovy-lsp/build/libs/groovy-lsp-*-all.jar --help
    - name: Prepare artifacts
      shell: bash
      run: |
        mkdir -p dist
        # Copy JAR with version in filename
        if [ "${{ matrix.os }}" = "self-hosted" ]; then
           # On self-hosted, we assume the JAR is portable and generate all platform variants
           echo "Generating all platform artifacts from single build..."
           cp groovy-lsp/build/libs/groovy-lsp-*-all.jar dist/groovy-lsp-${BUILD_VERSION#v}-linux-amd64.jar
           cp groovy-lsp/build/libs/groovy-lsp-*-all.jar dist/groovy-lsp-${BUILD_VERSION#v}-darwin-amd64.jar
           cp groovy-lsp/build/libs/groovy-lsp-*-all.jar dist/groovy-lsp-${BUILD_VERSION#v}-windows-amd64.jar
        elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          cp groovy-lsp/build/libs/groovy-lsp-*-all.jar dist/groovy-lsp-${BUILD_VERSION#v}-linux-amd64.jar
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          cp groovy-lsp/build/libs/groovy-lsp-*-all.jar dist/groovy-lsp-${BUILD_VERSION#v}-darwin-amd64.jar
        elif [ "${{ matrix.os }}" = "windows-latest" ]; then
          cp groovy-lsp/build/libs/groovy-lsp-*-all.jar dist/groovy-lsp-${BUILD_VERSION#v}-windows-amd64.jar
        fi
    - name: Upload release artifacts
      uses: actions/upload-artifact@v6
      with:
        name: "release-artifacts-${{ matrix.os }}"
        path: dist/*
        retention-days: 7
  create-release:
    name: Create Release
    permissions:
      contents: write
    needs: build-release
    runs-on: ${{ (github.event.inputs.runner_label == 'self-hosted' || vars.CI_RUNNER_LABEL == 'self-hosted') && 'self-hosted' || (github.event.inputs.runner_label == 'local-macos' || vars.CI_RUNNER_LABEL == 'local-macos') && fromJSON('["self-hosted", "local-macos", "groovy-lsp"]') || (github.event.inputs.runner_label == 'magalu' || vars.CI_RUNNER_LABEL == 'magalu') && fromJSON('["self-hosted", "magalu", "groovy-lsp"]') || 'ubuntu-24.04' }}
    if: "${{ !inputs.dry_run }}"
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - name: Download all artifacts
      uses: actions/download-artifact@v7
      with:
        merge-multiple: true
        path: artifacts
    - name: Prepare release assets
      shell: bash
      run: |
        mkdir -p dist
        echo "Downloaded artifacts:"
        find artifacts -type f -name "*.jar" | sort

        # Move all artifacts to dist directory
        cp -r artifacts/* dist/ 2>/dev/null || true

        # Generate checksums
        cd dist
        if ls *.jar 1> /dev/null 2>&1; then
          sha256sum *.jar > checksums.txt
          echo "Checksums generated:"
          cat checksums.txt
        fi
    - name: Generate release notes
      id: release_notes
      shell: bash
      run: |
        # Use VERSION from build-release job to ensure consistency
        VERSION="${{ needs.build-release.outputs.build_version }}"
        echo "Using version from build: ${VERSION}"

        cat > release-notes.md <<EOF
        ## Groovy LSP ${VERSION}

        ### Installation

        Download the appropriate JAR for your platform:

        \`\`\`bash
        # Download JAR (replace linux-amd64 with your platform)
        curl -LO https://github.com/${{ github.repository }}/releases/download/${VERSION}/groovy-lsp-${VERSION#v}-linux-amd64.jar

        # Verify checksum
        curl -LO https://github.com/${{ github.repository }}/releases/download/${VERSION}/checksums.txt
        sha256sum -c checksums.txt --ignore-missing

        # Run the Language Server
        java -jar groovy-lsp-${VERSION#v}-linux-amd64.jar
        \`\`\`

        ### Supported Platforms

        - **Linux AMD64** \`groovy-lsp-${VERSION#v}-linux-amd64.jar\`
        - **macOS AMD64** \`groovy-lsp-${VERSION#v}-darwin-amd64.jar\`
        - **Windows AMD64** \`groovy-lsp-${VERSION#v}-windows-amd64.jar\`

        ### Usage

        The Groovy Language Server provides IDE features for Groovy development including:
        - Code completion
        - Syntax highlighting
        - Error checking
        - Go to definition
        - Find references

        ### What's Changed

        <!-- GitHub will auto-generate this section -->

        ---

        **Full Changelog**: https://github.com/${{ github.repository }}/compare/v0.0.1...${VERSION}
        EOF
    - name: Determine release settings
      id: release_info
      shell: bash
      run: |
        # Use VERSION from build-release job to ensure consistency
        VERSION="${{ needs.build-release.outputs.build_version }}"
        echo "Using version from build: ${VERSION}"

        # Determine prerelease/draft status
        if [[ "$VERSION" == manual-* ]]; then
          IS_PRERELEASE=true
          IS_DRAFT=true
        elif [[ "$VERSION" =~ (-rc|-beta|-alpha) ]]; then
          IS_PRERELEASE=true
          IS_DRAFT=${{ github.event_name == 'workflow_dispatch' && 'true' || 'false' }}
        else
          IS_PRERELEASE=false
          IS_DRAFT=${{ github.event_name == 'workflow_dispatch' && 'true' || 'false' }}
        fi

        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
        echo "is_draft=${IS_DRAFT}" >> $GITHUB_OUTPUT

        echo "Release settings:"
        echo "- Version: ${VERSION}"
        echo "- Prerelease: ${IS_PRERELEASE}"
        echo "- Draft: ${IS_DRAFT}"
    - name: Create GitHub release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "${{ steps.release_info.outputs.version }}"
        draft: "${{ steps.release_info.outputs.is_draft }}"
        prerelease: "${{ steps.release_info.outputs.is_prerelease }}"
        name: "Groovy LSP ${{ steps.release_info.outputs.version }}"
        body_path: release-notes.md
        generate_release_notes: true
        files: |
          dist/groovy-lsp-*.jar
          dist/checksums.txt
        fail_on_unmatched_files: false
        make_latest: "${{ steps.release_info.outputs.is_prerelease == 'false' }}"
    - name: Release summary
      shell: bash
      run: |-
        echo "âœ… Release created successfully!"
        echo "ğŸ“¦ Version: ${{ steps.release_info.outputs.version }}"
        echo "ğŸ·ï¸ Tag: ${{ steps.release_info.outputs.version }}"
        echo "ğŸ“ Draft: ${{ steps.release_info.outputs.is_draft }}"
        echo "ğŸ”– Prerelease: ${{ steps.release_info.outputs.is_prerelease }}"
        echo ""
        echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_info.outputs.version }}"
        echo ""
        echo "ğŸ“‹ Artifacts included:"
        cd dist
        for file in groovy-lsp-*.jar checksums.txt; do
          if [[ -f "$file" ]]; then
            size=$(ls -lh "$file" | awk '{print $5}')
            echo "  - $file ($size)"
          fi
        done
