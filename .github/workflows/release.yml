name: Release
"on":
  push:
    tags:
    - v*
  workflow_dispatch:
    inputs:
      runner_label:
        description: 'Runner label to use'
        required: false
        type: choice
        options:
          - 'github-hosted'
          - 'self-hosted'
          - 'local-macos'
          - 'magalu'
        default: 'github-hosted'
      tag:
        description: 'Tag to release (for re-running failed releases)'
        required: false
        type: string
      dry_run:
        description: Dry run (don't create release)
        required: false
        type: boolean
        default: false
      disable_scan:
        description: Disable Gradle build scan
        required: false
        type: boolean
        default: false
jobs:
  build-release:
    name: Build Release Artifacts
    permissions:
      contents: read
    timeout-minutes: 60
    runs-on: ${{ matrix.os == 'self-hosted' && 'self-hosted' || matrix.os == 'local-macos' && fromJSON('["self-hosted", "local-macos", "groovy-lsp"]') || matrix.os == 'magalu' && fromJSON('["self-hosted", "magalu", "groovy-lsp"]') || matrix.os }}
    outputs:
      build_version: ${{ steps.set-env.outputs.build_version }}
      build_commit: ${{ steps.set-env.outputs.build_commit }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ${{ (github.event.inputs.runner_label == 'self-hosted' || vars.CI_RUNNER_LABEL == 'self-hosted') && 'self-hosted' || (github.event.inputs.runner_label == 'local-macos' || vars.CI_RUNNER_LABEL == 'local-macos') && 'local-macos' || (github.event.inputs.runner_label == 'magalu' || vars.CI_RUNNER_LABEL == 'magalu') && 'magalu' || 'ubuntu-24.04' }}
        java:
          - 17
    steps:
    - name: Validate tag input
      if: github.event.inputs.tag != ''
      shell: bash
      env:
        TAG_INPUT: ${{ github.event.inputs.tag }}
      run: |
        # Validate tag matches expected version format (v1.2.3 or v1.2.3-rc.1 or vscode-groovy-v1.2.3)
        if [[ ! "$TAG_INPUT" =~ ^(v|vscode-groovy-v)?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
          echo "::error::Invalid tag format: $TAG_INPUT. Expected formats: v1.2.3, v1.2.3-rc.1, or vscode-groovy-v1.2.3"
          exit 1
        fi
        echo "Tag validation passed: $TAG_INPUT"
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0
        ref: ${{ github.event.inputs.tag || github.ref }}
    - name: "Set up JDK ${{ matrix.java }}"
      uses: actions/setup-java@8df638a2e1d743a411e15faec45eb5220c33d59e # v4.7.0
      with:
        distribution: temurin
        java-version: "${{ matrix.java }}"
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@d156388eb19639ec20ade50009f3d199ce1e2808 # v4.1.0
      with:
        cache-read-only: false
    - name: Set Gradle scan flag
      shell: bash
      run: |-
        if [[ "${{ github.event.inputs.disable_scan }}" == "true" ]]; then
          echo "GRADLE_SCAN_FLAG=-Dorg.gradle.scan=false" >> $GITHUB_ENV
        else
          echo "GRADLE_SCAN_FLAG=" >> $GITHUB_ENV
        fi
    - name: Set build environment variables
      id: set-env
      shell: bash
      run: |
        # Priority: tag input > push tag > fallback (if not a version tag)
        TAG="${{ github.event.inputs.tag }}"
        TAG="${TAG:-${{ github.ref_name }}}"
        # Normalize: add v prefix if missing (allows input of "0.4.5" or "v0.4.5")
        [[ -n "$TAG" && "$TAG" =~ ^[0-9] ]] && TAG="v${TAG}"
        # If TAG doesn't look like a version tag (v*), generate manual version
        [[ ! "$TAG" =~ ^v[0-9] ]] && TAG="manual-$(date +%Y%m%d-%H%M%S)"
        
        # Get actual commit SHA from checked-out code (not github.sha which is dispatch trigger)
        COMMIT_SHA=$(git rev-parse HEAD)

        echo "Release version: ${TAG}"
        echo "Commit SHA: ${COMMIT_SHA}"
        echo "BUILD_VERSION=${TAG}" >> $GITHUB_ENV
        echo "BUILD_COMMIT=${COMMIT_SHA}" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
        
        # Set outputs for downstream jobs
        echo "build_version=${TAG}" >> $GITHUB_OUTPUT
        echo "build_commit=${COMMIT_SHA}" >> $GITHUB_OUTPUT
    - name: Validate Release Script
      run: ./tools/release.sh validate --version "${{ env.BUILD_VERSION }}"

    - name: Build with Release Script
      shell: bash
      run: |
        ./tools/release.sh build --version "${{ env.BUILD_VERSION }}"
        
    - name: Generate Checksums
      run: ./tools/release.sh checksums
    - name: Upload release artifacts
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: "release-artifacts-${{ matrix.os }}"
        path: dist/*
        retention-days: 7
  create-release:
    name: Create Release
    permissions:
      contents: write
    needs: build-release
    outputs:
      tag_name: ${{ steps.release_info.outputs.version }}
      version_no_v: ${{ steps.release_info.outputs.version_no_v }}
      is_prerelease: ${{ steps.release_info.outputs.is_prerelease }}
      is_draft: ${{ steps.release_info.outputs.is_draft }}
    runs-on: ${{ (github.event.inputs.runner_label == 'self-hosted' || vars.CI_RUNNER_LABEL == 'self-hosted') && 'self-hosted' || (github.event.inputs.runner_label == 'local-macos' || vars.CI_RUNNER_LABEL == 'local-macos') && fromJSON('["self-hosted", "local-macos", "groovy-lsp"]') || (github.event.inputs.runner_label == 'magalu' || vars.CI_RUNNER_LABEL == 'magalu') && fromJSON('["self-hosted", "magalu", "groovy-lsp"]') || 'ubuntu-24.04' }}
    if: "${{ !inputs.dry_run }}"
    steps:
    - name: Validate tag input
      if: github.event.inputs.tag != ''
      shell: bash
      env:
        TAG_INPUT: ${{ github.event.inputs.tag }}
      run: |
        # Validate tag matches expected version format (v1.2.3 or v1.2.3-rc.1 or vscode-groovy-v1.2.3)
        if [[ ! "$TAG_INPUT" =~ ^(v|vscode-groovy-v)?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
          echo "::error::Invalid tag format: $TAG_INPUT. Expected formats: v1.2.3, v1.2.3-rc.1, or vscode-groovy-v1.2.3"
          exit 1
        fi
        echo "Tag validation passed: $TAG_INPUT"
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0
        ref: ${{ github.event.inputs.tag || github.ref }}
    - name: Download all artifacts
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
      with:
        merge-multiple: true
        path: artifacts
    - name: Prepare release assets
      shell: bash
      run: |
        mkdir -p dist
        echo "Downloaded artifacts:"
        find artifacts -type f | sort

        # Move all artifacts to dist directory
        cp -r artifacts/* dist/ 2>/dev/null || true
        
        # Checksums are already generated by release script
        cat dist/checksums.txt || echo "No checksums found"
    - name: Generate release notes
      id: release_notes
      shell: bash
      run: |
        # Use VERSION from build-release job to ensure consistency
        VERSION="${{ needs.build-release.outputs.build_version }}"
        echo "Using version from build: ${VERSION}"

        cat > release-notes.md <<EOF
        ## Groovy DevTools ${VERSION}

        This release includes:
        - **gls** (Groovy Language Server) - JAR download
        - **gvy** (IDE extension) - VS Code, Open VSX

        ### Installation

        Download the appropriate JAR for your platform:

        \`\`\`bash
        # Download JAR (replace linux-amd64 with your platform)
        curl -LO https://github.com/${{ github.repository }}/releases/download/${VERSION}/gls-${VERSION#v}-linux-amd64.jar

        # Verify checksum
        curl -LO https://github.com/${{ github.repository }}/releases/download/${VERSION}/checksums.txt
        sha256sum -c checksums.txt --ignore-missing

        # Run the Language Server
        java -jar gls-${VERSION#v}-linux-amd64.jar
        \`\`\`

        ### Supported Platforms

        - **Linux AMD64** \`gls-${VERSION#v}-linux-amd64.jar\`
        - **macOS AMD64** \`gls-${VERSION#v}-darwin-amd64.jar\`
        - **Windows AMD64** \`gls-${VERSION#v}-windows-amd64.jar\`

        ### Usage

        The Groovy Language Server provides IDE features for Groovy development including:
        - Code completion
        - Syntax highlighting
        - Error checking
        - Go to definition
        - Find references

        ### What's Changed

        <!-- GitHub will auto-generate this section -->

        ---

        **Full Changelog**: https://github.com/${{ github.repository }}/compare/v0.0.1...${VERSION}
        EOF
    - name: Determine release settings
      id: release_info
      shell: bash
      run: |
        # Use VERSION from build-release job to ensure consistency
        VERSION="${{ needs.build-release.outputs.build_version }}"
        echo "Using version from build: ${VERSION}"

        # Determine prerelease/draft status
        if [[ "$VERSION" == manual-* ]]; then
          IS_PRERELEASE=true
          IS_DRAFT=true
        elif [[ "$VERSION" =~ (-rc|-beta|-alpha) ]]; then
          IS_PRERELEASE=true
          IS_DRAFT=${{ github.event_name == 'workflow_dispatch' && 'true' || 'false' }}
        else
          IS_PRERELEASE=false
          IS_DRAFT=${{ github.event_name == 'workflow_dispatch' && 'true' || 'false' }}
        fi

        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "version_no_v=${VERSION#v}" >> $GITHUB_OUTPUT
        echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
        echo "is_draft=${IS_DRAFT}" >> $GITHUB_OUTPUT

        echo "Release settings:"
        echo "- Version: ${VERSION}"
        echo "- Prerelease: ${IS_PRERELEASE}"
        echo "- Draft: ${IS_DRAFT}"
    - name: Create GitHub release
      uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
      with:
        tag_name: "${{ steps.release_info.outputs.version }}"
        draft: "${{ steps.release_info.outputs.is_draft }}"
        prerelease: "${{ steps.release_info.outputs.is_prerelease }}"
        name: "Groovy DevTools ${{ steps.release_info.outputs.version }}"
        body_path: release-notes.md
        generate_release_notes: true
        files: |
        files: |
          dist/*
        fail_on_unmatched_files: false
        make_latest: "${{ steps.release_info.outputs.is_prerelease == 'false' }}"
    - name: Release summary
      shell: bash
      run: |-
        echo "‚úÖ Release created successfully!"
        echo "üì¶ Version: ${{ steps.release_info.outputs.version }}"
        echo "üè∑Ô∏è Tag: ${{ steps.release_info.outputs.version }}"
        echo "üìù Draft: ${{ steps.release_info.outputs.is_draft }}"
        echo "üîñ Prerelease: ${{ steps.release_info.outputs.is_prerelease }}"
        echo ""
        echo "üîó Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_info.outputs.version }}"
        echo ""
        echo "üìã Artifacts included:"
        cd dist
        for file in *; do
          if [[ -f "$file" ]]; then
            size=$(ls -lh "$file" | awk '{print $5}')
            echo "  - $file ($size)"
          fi
        done

  publish-homebrew:
    needs: create-release
    runs-on: ubuntu-latest
    if: ${{ !inputs.dry_run }}
    steps:
      - name: Update Homebrew Formula
        uses: mislav/bump-homebrew-formula-action@f71360f9947bd3578768a4150df2c40c15a775bd # v3.2
        with:
          homebrew-tap: albertocavalcante/homebrew-tap
          formula-name: gls
          download-url: https://github.com/albertocavalcante/groovy-devtools/releases/download/${{ needs.create-release.outputs.tag_name }}/gls-${{ needs.create-release.outputs.version_no_v }}-generic.jar
          commit-message: "chore: update gls to {{version}}"
        env:
          COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

  # VS Code Extension publish (unified release - triggers on v* tags)
  publish-extension:
    name: Publish VS Code Extension
    needs: create-release
    if: ${{ !inputs.dry_run }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.create-release.outputs.tag_name }}

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: editors/code/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@8df638a2e1d743a411e15faec45eb5220c33d59e # v4.7.0
        with:
          distribution: temurin
          java-version: 17

      - name: Install dependencies
        run: npm ci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download release artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: release-artifacts-ubuntu-24.04 
          # Note: We assume ubuntu-24.04 (linux) build produced the VSIX or we use a matrix-agnostic name if we change that later.
          # For now, simplistic approach: use the linux artifact which usually runs first/fastest.
          path: dist
          
      - name: Publish to VS Code Marketplace
        run: npx @vscode/vsce publish -p ${{ secrets.VSCE_TOKEN }} --packagePath dist/*.vsix

      # Uncomment when ready to publish to Open VSX
      # - name: Publish to Open VSX Registry
      #   run: npx ovsx publish -p ${{ secrets.OVSX_TOKEN }}

      - name: Upload VSIX to release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          files: editors/code/*.vsix
          tag_name: ${{ needs.create-release.outputs.tag_name }}
